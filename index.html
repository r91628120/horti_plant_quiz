<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>園藝丙級術科識別線上模擬測驗</title>
<meta name="description" content="園藝丙級術科識別線上模擬測驗：共100題、40分鐘、單選題。圖片來源：勞動部勞動力發展署技能檢定中心，僅供教育與非營利用途。">
<meta name="robots" content="index,follow">
<style>
  :root{
    --brand:#2563eb; --muted:#eef2f7; --ink:#111827; --sub:#6b7280; --ok:#16a34a; --bad:#dc2626; --amber:#f59e0b;
  }
  html,body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Hiragino Sans","Microsoft JhengHei",sans-serif;color:var(--ink);background:#f5f7fb}
  .wrap{max-width:1080px;margin:24px auto;padding:0 16px}
  .card{background:#fff;border-radius:14px;box-shadow:0 6px 22px rgba(0,0,0,.06);padding:24px}
  h1{margin:.2rem 0 1rem;font-size:clamp(22px,2.8vw,32px)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .pill{display:inline-flex;align-items:center;gap:.5rem;background:var(--muted);color:#334155;padding:6px 12px;border-radius:999px;font-size:14px}
  .counter-badge{display:inline-flex;align-items:center;gap:.5rem;padding:6px 12px;border-radius:12px;background:#eef2ff;border:1px solid #e5e7ff}
  .badge-dot{width:8px;height:8px;border-radius:50%}
  .dot-spinning{background:var(--amber);animation:blink 1s infinite}
  .dot-ok{background:var(--ok)}
  .dot-off{background:#999}
  @keyframes blink{50%{opacity:.2}}
  input[type=text]{border:1px solid #e5e7eb;border-radius:10px;padding:10px 14px;font-size:16px;min-width:260px;background:#fff}
  select{border:1px solid #e5e7eb;border-radius:10px;padding:10px 14px;font-size:16px;min-width:240px;background:#fff}
  button{border:0;background:var(--brand);color:#fff;border-radius:12px;padding:12px 18px;font-size:16px;cursor:pointer}
  button.ghost{background:#eef2ff;color:#1d4ed8}
  button:disabled{opacity:.5;cursor:not-allowed}
  .bar{height:6px;border-radius:999px;background:#e5e7eb;overflow:hidden}
  .bar>i{display:block;height:100%;background:var(--brand);width:0%}
  .imgbox{display:flex;align-items:center;justify-content:center;background:#f1f5f9;border:2px dashed #e5e7eb;border-radius:14px;min-height:420px;overflow:hidden}
  .imgbox>img{max-width:100%;max-height:70vh;display:block}
  .opts{display:grid;gap:10px;margin-top:14px}
  .opt{background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px;cursor:pointer;display:flex;align-items:center;gap:10px}
  .opt input{margin:0}
  .opt.correct{border-color:var(--ok);background:#ecfdf5}
  .opt.wrong{border-color:var(--bad);background:#fef2f2}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .hide{display:none}
  .footer{color:#475569;font-size:14px;margin-top:18px}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0f172a;color:#e2e8f0;padding:10px;border-radius:10px}
  .numguide{display:flex;gap:6px;flex-wrap:wrap}
  .numguide button{background:#e2e8f0;color:#0f172a;padding:6px 10px;border-radius:8px}
  .numguide button.done{background:#c7f9cc;color:#065f46}
  .muted{color:#6b7280}
</style>
</head>
<body>
<div class="wrap">
  <!-- A. 首頁 -->
  <section id="home" class="card">
    <div class="row">
      <h1>園藝丙級術科識別線上模擬測驗</h1>
      <span class="pill">ver <span id="ver">–</span></span>
    </div>

    <div class="row" style="margin:.4rem 0 1rem">
      <span class="pill">來源：<b id="sourceLabel">GCS</b></span>
      <span class="counter-badge" id="cloudBadge" title="雲端連線狀態">
        <span class="badge-dot dot-off" id="cloudDot"></span>
        <span id="cloudText" class="muted">雲端：離線</span>
      </span>
    </div>

    <div class="row" style="margin:.2rem 0 1rem">
      <span class="pill">目前累計測驗人數：<b id="globalCount">000000 人</b></span>
    </div>

    <div class="row" style="margin:12px 0 6px">
      <input id="uname" type="text" placeholder="姓名/代號" />
      <select id="bankSel" title="選擇題庫分類">
        <option value="mix">全部題庫（依比例組卷）</option>
        <option value="A">僅 A 水生植物</option>
        <option value="B">僅 B 果樹</option>
        <option value="C">僅 C 草本植物</option>
        <option value="D">僅 D 資材</option>
        <option value="E">僅 E 灌木</option>
        <option value="F">僅 F 喬木</option>
        <option value="G">僅 G 蔬菜</option>
        <option value="H">僅 H 蔓性植物</option>
      </select>
      <button id="btnStart">開始測驗（100 題）</button>
      <button id="btnQuick" class="ghost">⚡ 快速體驗 10 題</button>
    </div>

    <div style="margin-top:12px" class="footer">
      資料來源：<b>勞動部勞動力發展署技能檢定中心</b>。本網站圖片僅供教育與非營利用途，著作權歸原權利人所有，<b>嚴禁未經授權之商業使用</b>。<br>
      © 2025 Horti ID Quiz · Email: 91628120@ctvs.ptc.edu.tw（支援 <code>questions.json</code> 類別題庫）
    </div>
  </section>

  <!-- B. 作答頁 -->
  <section id="exam" class="card hide">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <span class="pill">考生：<b id="who">—</b></span>
        <span class="pill">題數：<b id="countLabel">0/0</b></span>
        <span class="pill">40:00</span>
      </div>
      <div style="flex:1;max-width:520px" class="bar"><i id="bar"></i></div>
    </div>

    <h3 id="qtitle" style="margin:14px 0">第 1 / 0 題</h3>
    <div class="imgbox"><img id="qimg" alt="題目圖片"></div>
    <div class="opts" id="opts"></div>

    <div class="row" style="margin-top:12px">
      <button id="btnPrev" class="ghost">← 上一題</button>
      <button id="btnNext" class="ghost">下一題 →</button>
      <button id="btnSubmit">交卷</button>
    </div>

    <div style="margin-top:10px">
      <div class="muted" style="margin-bottom:6px">題目導覽</div>
      <div id="numguide" class="numguide"></div>
    </div>
  </section>

  <!-- C. 結果頁 -->
  <section id="result" class="card hide">
    <h2>測驗結果</h2>
    <div class="row">
      <span class="pill">姓名/代號：<b id="rWho">—</b></span>
      <span class="pill">題數：<b id="rCount">0</b></span>
      <span class="pill">得分：<b id="rScore">0</b></span>
      <span class="pill">版本：<b id="rVer">—</b></span>
    </div>

    <div style="margin:14px 0">
      <table id="rTable" style="border-collapse:collapse;width:100%">
        <thead>
          <tr style="background:#f1f5f9">
            <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb">#</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb">題圖</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb">你的答案</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb">正確答案</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb">判定</th>
          </tr>
        </thead>
        <tbody id="rBody"></tbody>
      </table>
    </div>

    <div class="row">
      <button id="btnHome" class="ghost">回首頁</button>
      <button id="btnRetry">再測一次</button>
    </div>
  </section>
</div>

<script>
/* ----------------------- 0) 全域設定 ----------------------- */

// 你的 Apps Script Web App 「exec」或 googleusercontent echo 版 URL：
const COUNTER_URL = 'https://script.googleusercontent.com/macros/echo?user_content_key=REPLACE_ME&lib=REPLACE_ME';
// ↑↑ 把上面換成你自己的 URL

// 顯示來源字樣（固定顯示 GCS）
document.getElementById('sourceLabel').textContent = 'GCS';

// 題庫配比（100 題）
const QUOTA_100 = { B:20, G:20, A:4, H:6, C:20, E:10, F:10, D:10 };
const LABELS = ['A','B','C','D'];

// 全域狀態
let QUESTIONS = [];         // 100 題
let CUR = 0;                // 目前題號 (0-based)
let ANSW = [];              // 每題作答 -1 未作，0..3 A-D
let TIMER = null;           // 倒數計時
let LEFT = 40*60;           // 40 分
let VERSION = '—';          // 版本號
let RAW = null;             // questions.json 原始資料

/* ----------------------- 1) 工具 ----------------------- */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const fmt = n => String(n).padStart(6,'0');
const baseName = s => (s||'').replace(/_\d+$/,''); // 砍尾號

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = (Math.random()* (i+1))|0;
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}
function pick(arr,n){
  if(n>=arr.length) return shuffle(arr.slice());
  return shuffle(arr.slice()).slice(0,n);
}

/* ----------------------- 2) 雲端計數器（無重試鈕） ----------------------- */
const cloudDot  = $('#cloudDot');
const cloudText = $('#cloudText');
const cloudBadge= $('#cloudBadge');
const globalCountEl = $('#globalCount');

function badge(state, note){
  if(state==='loading'){ cloudDot.className='badge-dot dot-spinning'; cloudText.textContent='雲端：連線中'; }
  else if(state==='ok'){ cloudDot.className='badge-dot dot-ok'; cloudText.textContent='雲端：已同步'; }
  else { cloudDot.className='badge-dot dot-off'; cloudText.textContent='雲端：離線'; if(note) cloudBadge.title = note; }
}

function showCount(n){
  if(!Number.isFinite(n)) return;
  globalCountEl.textContent = fmt(n)+' 人';
}

function loadCounter(){
  // 先用 localStorage 顯示
  const local = Number(localStorage.getItem('globalCount')||0);
  showCount(local);

  // 背景拉雲端
  if(!COUNTER_URL.startsWith('http')) return badge('off','未設定 COUNTER_URL');
  badge('loading');

  fetch(COUNTER_URL, {method:'GET', mode:'cors'})
    .then(r=>r.json())
    .then(j=>{
      if(j && j.ok===true && Number.isFinite(j.count)){
        showCount(j.count);
        localStorage.setItem('globalCount', j.count);
        badge('ok');
      }else{
        badge('off','回傳格式不正確');
      }
    })
    .catch(e=>badge('off', String(e)));
}

function incrementCounterOptimistic(){
  // UI 樂觀 +1（本地）
  const now = Number(localStorage.getItem('globalCount')||0) + 1;
  localStorage.setItem('globalCount', now);
  showCount(now);

  // 背景遞增（sendBeacon 優先，不等結果）
  badge('loading');
  const payload = JSON.stringify({inc:1});
  let sent = false;
  try {
    const blob = new Blob([payload], {type:'application/json'});
    if(navigator.sendBeacon){
      sent = navigator.sendBeacon(COUNTER_URL, blob);
    }
  }catch(_) {}

  // 如 sendBeacon 失敗，就用 fetch 但不 await（完全不阻塞 UI）
  if(!sent){
    fetch(COUNTER_URL, {
      method:'POST',
      mode:'cors',
      headers:{'Content-Type':'application/json'},
      body:payload
    }).catch(()=>{}).finally(()=>badge('ok'));
  } else {
    // sendBeacon 不會有回傳，就當成功
    setTimeout(()=>badge('ok'),400);
  }
}

/* ----------------------- 3) 題庫載入 + 組卷 ----------------------- */
async function loadQuestions(){
  // 支援同站的 questions.json
  const url = 'questions.json?t=' + Date.now();
  const r = await fetch(url); RAW = await r.json();
  VERSION = RAW?.version || '—';
  $('#ver').textContent = VERSION;

  // 建立「名稱 -> 相同名稱圖片清單」(每張為一個 item)
  const allKeys = ['A','B','C','D','E','F','G','H'].filter(k=>Array.isArray(RAW[k]));
  const pools = {};
  for(const k of allKeys){
    pools[k] = RAW[k].slice(); // 每張圖就是一題候選
  }
  return {allKeys, pools};
}

function makePaperMix(pools){
  // 依比例從各類別抽
  const picked = [];
  for(const [k,n] of Object.entries(QUOTA_100)){
    if(!pools[k]) continue;
    picked.push(...pick(pools[k], Math.min(n, pools[k].length)));
  }
  // 若不足 100，從所有類別補足
  let deficit = 100 - picked.length;
  if(deficit>0){
    const all = Object.values(pools).flat();
    const candidates = all.filter(x=>!picked.includes(x));
    picked.push(...pick(candidates, Math.min(deficit, candidates.length)));
  }
  return picked.slice(0,100);
}

function makePaperSingle(pools, key, N){
  const bag = pools[key]||[];
  return pick(bag, Math.min(N, bag.length));
}

function buildExamItems(chosen, pools){
  // 準備所有「名稱（不含尾號）」清單，用於產生錯誤選項
  const allNames = new Set();
  for(const arr of Object.values(pools)){
    for(const it of arr) allNames.add(baseName(it.name));
  }
  const allNameList = Array.from(allNames);

  const items = chosen.map((it, idx)=>{
    const correctName = baseName(it.name);
    // 3 個錯誤（不同名稱）
    const wrongNames = shuffle(allNameList.filter(n=>n!==correctName)).slice(0,3);
    const options = shuffle([correctName, ...wrongNames]).map((txt,i)=>({
      label: LABELS[i], text: txt, correct: (txt===correctName)
    }));
    const ansIndex = options.findIndex(o=>o.correct);
    return {
      no: idx+1,
      image: it.image,
      correctName,
      options,
      ansIndex
    };
  });
  return items;
}

/* ----------------------- 4) UI 切換 ----------------------- */
function show(id){
  for(const sec of ['home','exam','result']){
    const el = document.getElementById(sec);
    if(el) el.classList.toggle('hide', sec!==id);
  }
}

/* ----------------------- 5) 作答流程 ----------------------- */
function renderQuestion(){
  const q = QUESTIONS[CUR];
  $('#qtitle').textContent = `第 ${CUR+1} / ${QUESTIONS.length} 題`;
  $('#qimg').src = q.image; $('#qimg').alt = q.correctName;
  $('#countLabel').textContent = `${CUR+1}/${QUESTIONS.length}`;
  $('#bar').style.width = `${(CUR)/QUESTIONS.length*100}%`;

  const me = ANSW[CUR];
  const opts = $('#opts'); opts.innerHTML = '';
  q.options.forEach((op,i)=>{
    const div = document.createElement('label');
    div.className = 'opt';
    div.innerHTML = `<input type="radio" name="opt" value="${i}"><b>${op.label}.</b> ${op.text}`;
    const inp = div.querySelector('input');
    if(me===i) inp.checked = true;
    inp.addEventListener('change', ()=>{
      ANSW[CUR] = i;
      renderGuide();
    });
    opts.appendChild(div);
  });

  $('#btnPrev').disabled = (CUR<=0);
  $('#btnNext').disabled = (CUR>=QUESTIONS.length-1);
}
function renderGuide(){
  const box = $('#numguide'); box.innerHTML = '';
  for(let i=0;i<QUESTIONS.length;i++){
    const b = document.createElement('button');
    b.textContent = i+1;
    if(ANSW[i]>=0) b.classList.add('done');
    b.addEventListener('click',()=>{ CUR=i; renderQuestion(); });
    box.appendChild(b);
  }
}

function startTimer(){
  const pill = document.querySelectorAll('.pill')[2]; // 顯示 40:00 的那顆
  if(TIMER) clearInterval(TIMER);
  const tick = ()=>{
    const m = Math.floor(LEFT/60), s = LEFT%60;
    pill.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    if(LEFT<=0){ clearInterval(TIMER); submitExam(); }
    LEFT--;
  };
  tick();
  TIMER = setInterval(tick,1000);
}

function submitExam(){
  if(TIMER) clearInterval(TIMER);
  // 評分
  let score = 0;
  const rows = [];
  for(let i=0;i<QUESTIONS.length;i++){
    const q = QUESTIONS[i];
    const my = ANSW[i];
    const ok = (my===q.ansIndex);
    if(ok) score++;
    rows.push({no:i+1,img:q.image,my:my>=0?LABELS[my]+'. '+q.options[my].text:'—',ans:LABELS[q.ansIndex]+'. '+q.options[q.ansIndex].text,ok});
  }

  // 結果頁
  $('#rWho').textContent = $('#uname').value || '—';
  $('#rCount').textContent = `${QUESTIONS.length}`;
  $('#rScore').textContent = `${score}`;
  $('#rVer').textContent = VERSION;

  const tb = $('#rBody'); tb.innerHTML='';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="padding:8px;border-bottom:1px solid #e5e7eb">${r.no}</td>
      <td style="padding:8px;border-bottom:1px solid #e5e7eb"><img src="${r.img}" alt="" style="max-height:80px;border:1px solid #eee;border-radius:6px"></td>
      <td style="padding:8px;border-bottom:1px solid #e5e7eb">${r.my}</td>
      <td style="padding:8px;border-bottom:1px solid #e5e7eb">${r.ans}</td>
      <td style="padding:8px;border-bottom:1px solid #e5e7eb;color:${r.ok?'#16a34a':'#dc2626'}">${r.ok?'✔ 正確':'✘ 錯誤'}</td>`;
    tb.appendChild(tr);
  });
  show('result');
}

/* ----------------------- 6) 事件 ----------------------- */
$('#btnStart').addEventListener('click', async ()=>{
  // 樂觀遞增不阻塞 UI
  incrementCounterOptimistic();

  // 組卷
  const who = $('#uname').value.trim() || '—';
  $('#who').textContent = who;
  const {pools} = await loadQuestions();

  const mode = $('#bankSel').value;
  let chosen = [];
  if(mode==='mix'){
    chosen = makePaperMix(pools);
  }else{
    chosen = makePaperSingle(pools, mode, 100);
    if(chosen.length<100){
      // 不足 100 用全部補
      const rest = 100-chosen.length;
      const all = Object.values(pools).flat();
      chosen = chosen.concat(pick(all.filter(x=>!chosen.includes(x)), rest));
    }
  }
  QUESTIONS = buildExamItems(chosen, pools);
  ANSW = Array(QUESTIONS.length).fill(-1);
  CUR=0; LEFT=40*60;

  renderQuestion();
  renderGuide();
  startTimer();
  show('exam');
});
$('#btnQuick').addEventListener('click', async ()=>{
  // 不紀錄人數
  const who = $('#uname').value.trim() || '—';
  $('#who').textContent = who;
  const {pools} = await loadQuestions();
  const chosen = makePaperMix(pools).slice(0,10);
  QUESTIONS = buildExamItems(chosen, pools);
  ANSW = Array(10).fill(-1);
  CUR=0; LEFT=10*60;
  renderQuestion(); renderGuide(); startTimer(); show('exam');
});

$('#btnPrev').addEventListener('click', ()=>{ if(CUR>0){ CUR--; renderQuestion(); }});
$('#btnNext').addEventListener('click', ()=>{ if(CUR<QUESTIONS.length-1){ CUR++; renderQuestion(); }});
$('#btnSubmit').addEventListener('click', submitExam);

$('#btnHome').addEventListener('click', ()=>{ location.href = location.pathname + '?t=' + Date.now(); });
$('#btnRetry').addEventListener('click', ()=>{ location.href = location.pathname + '?t=' + Date.now(); });

/* ----------------------- 7) 啟動 ----------------------- */
loadCounter();  // 啟動時：先本地、再雲端
</script>
</body>
</html>
