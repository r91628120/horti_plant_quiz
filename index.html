<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>園藝丙級術科識別線上模擬測驗｜Horti ID Quiz</title>
  <meta name="description" content="園藝丙級術科識別線上模擬測驗：依八大類題庫比例自動組卷（果樹、蔬菜、水生、蔓性、草本、灌木、喬木、資材），每題配圖單選，40分鐘倒數，支援快速體驗10題。"/>
  <meta name="keywords" content="園藝丙級,術科,識別,模擬測驗,果樹,蔬菜,水生植物,蔓性植物,草本,灌木,喬木,資材,題庫,練習"/>
  <meta name="robots" content="index,follow"/>

  <style>
    :root{
      --bg:#f6f8fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --primary:#2563eb; --primary-2:#1d4ed8; --good:#16a34a; --bad:#dc2626;
      --border:#e2e8f0;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:20px}
    h1{font-size:28px;margin:0 0 8px}
    h2{font-size:20px;margin:8px 0 16px;color:#1f2937}
    p{color:#334155;margin:6px 0}
    .muted{color:var(--muted)}
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    input,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#fff}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:12px 18px;border-radius:12px;border:1px solid var(--border);cursor:pointer;background:#f1f5f9}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.primary:hover{background:var(--primary-2)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .inline{display:inline-flex;gap:8px;align-items:center;flex-wrap:wrap}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;border:1px solid #c7d2fe}
    .progress{height:8px;border-radius:999px;background:#e5e7eb;overflow:hidden}
    .progress>span{display:block;height:100%;background:linear-gradient(90deg,#2563eb,#60a5fa);width:0}
    .img{width:100%;max-height:420px;object-fit:contain;border-radius:14px;border:1px solid var(--border);background:#f8fafc}
    .choices{display:grid;gap:10px;margin-top:12px}
    .choice{display:flex;gap:10px;align-items:flex-start;padding:12px;border-radius:12px;border:1px solid var(--border);background:#f8fafc;cursor:pointer}
    .choice input{transform:translateY(3px)}
    .choice.correct{border-color:#16a34a;background:#ecfdf5}
    .choice.wrong{border-color:#dc2626;background:#fef2f2}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .nav{display:flex;gap:6px;flex-wrap:wrap;margin-top:12px}
    .nav button{width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:#fff}
    .nav button.answered{background:#dbeafe;border-color:#2563eb}
    .footer{margin-top:20px;color:var(--muted);font-size:12px}
    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:720px){.grid-2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <!-- A 首頁 -->
    <section id="view-home" class="card">
      <h1>園藝丙級術科識別線上模擬測驗</h1>
      <p class="muted">
        資料來源：勞動部勞動力發展署技能檢定中心。本網站圖片僅供教育與非營利用途，著作權歸原權利人所有，嚴禁未經授權之商業使用。
      </p>
      <div class="card" style="background:#f8fafc">
        <p><b>測驗說明：</b>本試題共測試 <b>100 題</b>，每題 <b>1 分</b>，總分 <b>100 分</b>，考試時間 <b>40 分鐘</b>。題型為單選題，需依試題圖片配合選項點選，正確點選者始給分，題目可前後閱視作答。</p>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="col">
          <label>姓名 / 代號</label>
          <input id="inpName" placeholder="請輸入姓名或代號"/>
        </div>
        <div class="col">
          <label>選擇題庫分類</label>
          <select id="selCategory">
            <option value="ALL" selected>全部題庫（依比例組卷）</option>
          </select>
        </div>
      </div>

      <div class="inline" style="margin-top:12px">
        <span class="badge" id="badgeVer">ver -</span>
        <span class="muted">目前累計測驗人數：<span id="people">0</span> 人（本機）</span>
        <span class="muted">題庫：<span id="badgeBanks">—</span></span>
      </div>

      <div class="inline" style="margin-top:14px">
        <button id="btnStart" class="btn primary">▶ 開始測驗（100 題）</button>
        <button id="btnQuick" class="btn">⚡ 快速體驗（10 題）</button>
      </div>
    </section>

    <!-- B 作答頁 -->
    <section id="view-quiz" class="card" style="display:none">
      <div class="inline" style="justify-content:space-between;width:100%">
        <div class="inline">
          <span class="badge">考生：<span id="quizUser">-</span></span>
          <span class="badge">題數：<span id="quizTotal">0</span></span>
          <span class="badge">40:00</span>
        </div>
        <div class="progress" style="width:50%"><span id="bar"></span></div>
      </div>

      <h2 id="quizTitle">第 1 / 0 題</h2>
      <img id="quizImg" class="img" alt="題目圖片" src="" onerror="this.src='https://placehold.co/800x420?text=No+Image'"/>

      <div id="choices" class="choices"></div>

      <div class="toolbar">
        <button id="btnPrev" class="btn">← 上一題</button>
        <button id="btnNext" class="btn">下一題 →</button>
        <button id="btnSubmit" class="btn primary">交卷</button>
      </div>

      <div style="margin-top:10px">
        <h3 class="muted" style="margin:0 0 8px">題目導覽</h3>
        <div id="nav" class="nav"></div>
      </div>
    </section>

    <!-- C 結果頁 -->
    <section id="view-result" class="card" style="display:none">
      <h2>作答結果</h2>
      <p id="resName">應試者：-</p>
      <p id="resScore">得分：-</p>
      <p id="resVersion" class="muted">ver -</p>

      <div class="grid grid-2" style="margin-top:10px">
        <div>
          <h3>逐題對錯</h3>
          <table id="tbl" style="width:100%;border-collapse:collapse;border:1px solid var(--border)">
            <thead>
              <tr style="background:#f8fafc">
                <th style="padding:8px;border-bottom:1px solid var(--border);text-align:left">#</th>
                <th style="padding:8px;border-bottom:1px solid var(--border);text-align:left">你的答案</th>
                <th style="padding:8px;border-bottom:1px solid var(--border);text-align:left">正解</th>
                <th style="padding:8px;border-bottom:1px solid var(--border);text-align:left">結果</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div>
          <div class="card" style="background:#f8fafc">
            <p class="muted">
              資料來源：勞動部勞動力發展署技能檢定中心。本網站圖片僅供教育與非營利用途，著作權歸原權利人所有，嚴禁未經授權之商業使用。
            </p>
          </div>
        </div>
      </div>
    </section>

    <footer class="footer">© 2025 Horti ID Quiz．靜態前端（支援 <code>questions.json</code> 類別題庫）</footer>
  </div>

<script>
/* ====== 工具 ====== */
const $ = sel=>document.querySelector(sel);
const $$ = sel=>Array.from(document.querySelectorAll(sel));
const shuffle = arr=>arr.map(x=>[Math.random(),x]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
const sampleN = (arr,n)=>shuffle(arr).slice(0,Math.min(n,arr.length));
const by = (obj,key,def='-') => (obj && key in obj) ? obj[key] : def;

function titleFromImageUrl(url){
  // 嘗試從檔名切出中文名稱（去尾碼） e.g. xxx/香蕉_001.jpg -> 香蕉
  try{
    const name = decodeURIComponent(url.split('/').pop());
    return name.replace(/\.[a-z0-9]+$/i,'')
               .replace(/[_\- ]?\d+$/,''); // 去尾數字
  }catch{ return url; }
}

/* ====== 全域狀態 ====== */
let QUESTIONS = [];          // 全部題庫（平面）
let CATS = [];               // 類別清單（自 questions.json.categories 或由資料推得）
let VER = '-';

let STATE = {
  user: '',
  total: 0,
  idx: 0,
  questions: [],  // [{image,name, choices:[...], answer:'', your:null}]
  timer: 40*60,
  timerId: null
};

/* ====== 抽題比例（100題） ====== */
const PROPORTION_100 = {
  'fruit':20,
  'vegetables':20,
  'aquatic plants':4,
  'vine plants':6,
  'herbaceous plants':20,
  'shrub':10,
  'trees':10,
  'materials':10
};

/* ====== 載入題庫 ====== */
async function loadQuestions(){
  const res = await fetch('questions.json',{cache:'no-store'});
  const obj = await res.json();

  // 支援兩種格式：
  // 1) { version, categories, items:[{image,name,category}, ...] }
  // 2) { version, items:[{image,name,category}, ...] } (categories 缺省時自動彙整)
  VER = by(obj,'version','-');
  const items = by(obj,'items',[]);

  // 平面化題庫
  QUESTIONS = items.map(it=>({
    image: it.image,
    name : it.name || titleFromImageUrl(it.image),
    category: (it.category||'').trim().toLowerCase()
  })).filter(it=>it.image && it.name);

  // 類別
  if (Array.isArray(obj.categories) && obj.categories.length){
    CATS = obj.categories.map(c => c.trim().toLowerCase());
  }else{
    CATS = Array.from(new Set(QUESTIONS.map(q=>q.category))).filter(Boolean);
  }

  // 將類別填進首頁下拉（可單選某類／或 ALL）
  const sel = $('#selCategory');
  CATS.forEach(c=>{
    const opt = document.createElement('option');
    opt.value = c; opt.textContent = c;
    sel.appendChild(opt);
  });

  // 顯示版本＆題庫摘要
  $('#badgeVer').textContent = `ver ${VER}`;
  $('#badgeBanks').textContent = `${CATS.length} 類 / ${QUESTIONS.length} 題`;

  // 累計人數（本機）
  const p = +localStorage.getItem('horti_people') || 0;
  $('#people').textContent = p.toString();
}

/* ====== 依比例抽題 ====== */
function buildExam(count=100, scope='ALL'){
  // scope = 'ALL' → 依比例抽；scope = 某類 → 該類中等比抽滿 count
  const groups = groupByCategory(QUESTIONS);
  let picked = [];

  if (scope==='ALL'){
    // 計算各類目數量（按 PROPORTION_100）
    // 比例不存在的類別不抽
    let plan = {};
    const totalNeed = count;
    let remaining = totalNeed;

    // 先依比例取 floor，再分配餘數
    const keys = Object.keys(PROPORTION_100);
    keys.forEach(k=>{
      const want = Math.floor(PROPORTION_100[k] * count / 100);
      plan[k] = want;
      remaining -= want;
    });
    // 分配餘數（按比例排序遞補）
    const order = keys.slice().sort((a,b)=>PROPORTION_100[b]-PROPORTION_100[a]);
    let i=0;
    while(remaining>0 && i<order.length){
      const k = order[i%order.length];
      plan[k] = (plan[k]||0)+1;
      remaining--;
      i++;
    }

    // 根據計畫抽題
    for (const k of Object.keys(plan)){
      const src = by(groups,k,[]);
      const need = plan[k];
      if (need<=0) continue;
      picked.push(...sampleN(src, need));
    }

    // 若總數尚不足（因類別題目不足），補齊：從有題目的類別隨機補
    while(picked.length < count){
      const candidates = QUESTIONS.filter(q=>!picked.includes(q));
      if(!candidates.length) break;
      picked.push(sampleN(candidates,1)[0]);
    }
    picked = picked.slice(0,count);

  }else{
    // 單一類
    const src = by(groups, scope, []);
    picked = sampleN(src, count);
  }

  // 以 picked 為正解，為每題挑 3 個不同名稱的錯誤選項
  const allByName = groupByName(QUESTIONS);
  const allNames = Object.keys(allByName);

  const exam = picked.map(q=>{
    // 正確名稱
    const correct = q.name;
    // 準備錯誤名稱（不同於正解）
    const wrongNames = shuffle(allNames.filter(n=>n!==correct)).slice(0,3);
    // 選項：正解 + 3 錯誤
    const opts = shuffle([correct, ...wrongNames]);

    return {
      image: q.image,
      name : correct,
      choices: opts,
      answer: correct,
      your: null
    };
  });

  return exam;
}

function groupByCategory(list){
  const m = {};
  list.forEach(q=>{
    const k = (q.category||'').trim().toLowerCase();
    if(!m[k]) m[k] = [];
    m[k].push(q);
  });
  return m;
}
function groupByName(list){
  const m = {};
  list.forEach(q=>{
    const k = q.name.trim();
    if(!m[k]) m[k]=[];
    m[k].push(q);
  });
  return m;
}

/* ====== 顯示切換 ====== */
function show(id){
  ['#view-home','#view-quiz','#view-result'].forEach(sel=>$(sel).style.display='none');
  $(id).style.display='block';
}

/* ====== 作答頁渲染 ====== */
function renderQuiz(){
  const q = STATE.questions[STATE.idx];
  $('#quizUser').textContent = STATE.user;
  $('#quizTotal').textContent = STATE.total;
  $('#quizTitle').textContent = `第 ${STATE.idx+1} / ${STATE.total} 題`;
  $('#quizImg').src = q.image;

  const box = $('#choices');
  box.innerHTML='';
  const labels = ['A','B','C','D'];
  q.choices.forEach((txt,i)=>{
    const id = `opt_${STATE.idx}_${i}`;
    const wrap = document.createElement('label');
    wrap.className = 'choice';
    wrap.innerHTML = `
      <input type="radio" name="q_${STATE.idx}" id="${id}" ${q.your===txt?'checked':''}/>
      <span><b>${labels[i]}.</b> ${txt}</span>
    `;
    wrap.onclick = (e)=>{
      // radio 設定
      q.your = txt;
      renderNavPalette();
    };
    box.appendChild(wrap);
  });

  // 進度條
  $('#bar').style.width = `${(STATE.idx+1)/STATE.total*100}%`;

  // 導覽 palette
  renderNavPalette();
}
function renderNavPalette(){
  const nav = $('#nav');
  nav.innerHTML='';
  STATE.questions.forEach((q,idx)=>{
    const b = document.createElement('button');
    b.textContent = (idx+1);
    if (q.your) b.classList.add('answered');
    if (idx===STATE.idx) b.style.outline='2px solid #2563eb';
    b.onclick = ()=>{ STATE.idx=idx; renderQuiz(); };
    nav.appendChild(b);
  });
}

/* ====== 倒數 ====== */
function startTimer(sec){
  STATE.timer = sec;
  if(STATE.timerId) clearInterval(STATE.timerId);
  STATE.timerId = setInterval(()=>{
    STATE.timer--;
    if(STATE.timer<=0){
      clearInterval(STATE.timerId);
      submit();
    }
  },1000);
}

/* ====== 交卷 ====== */
function submit(){
  if(STATE.timerId) clearInterval(STATE.timerId);

  // 計分
  let correct=0;
  STATE.questions.forEach(q=>{ if(q.your===q.answer) correct++; });
  const score = correct; // 每題 1 分，共 100 題

  // 累計人數（本機）
  try{
    const p = +localStorage.getItem('horti_people') || 0;
    localStorage.setItem('horti_people', (p+1).toString());
  }catch{}

  // 渲染結果
  $('#resName').textContent = `應試者：${STATE.user}`;
  $('#resScore').textContent = `得分：${score} 分`;
  $('#resVersion').textContent = `ver ${VER}`;

  const tb = $('#tbody');
  tb.innerHTML='';
  STATE.questions.forEach((q,i)=>{
    const tr = document.createElement('tr');
    const ok = q.your===q.answer;
    tr.innerHTML = `
      <td style="padding:8px;border-bottom:1px solid var(--border)">${i+1}</td>
      <td style="padding:8px;border-bottom:1px solid var(--border)">${q.your || '<span class="muted">未作答</span>'}</td>
      <td style="padding:8px;border-bottom:1px solid var(--border)">${q.answer}</td>
      <td style="padding:8px;border-bottom:1px solid var(--border);color:${ok?'#16a34a':'#dc2626'}">${ok?'✔ 正確':'✘ 錯誤'}</td>
    `;
    tb.appendChild(tr);
  });

  // 回首頁更新人數
  const p = +localStorage.getItem('horti_people') || 0;
  $('#people').textContent = p.toString();

  show('#view-result');
}

/* ====== 事件 ====== */
$('#btnStart').onclick = ()=>{
  const name = $('#inpName').value.trim() || '未署名';
  const scope = $('#selCategory').value;    // ALL 或 某類
  STATE.user = name;

  // 100 題（八類比例）
  STATE.questions = buildExam(100, scope);
  STATE.total = STATE.questions.length;
  STATE.idx = 0;

  show('#view-quiz');
  renderQuiz();
  startTimer(40*60);
};
$('#btnQuick').onclick = ()=>{
  const name = $('#inpName').value.trim() || '未署名';
  const scope = $('#selCategory').value;
  STATE.user = name;

  // 快速體驗：10 題（按比例縮放）
  STATE.questions = buildExam(10, scope);
  STATE.total = STATE.questions.length;
  STATE.idx = 0;

  show('#view-quiz');
  renderQuiz();
  startTimer(10*60); // 體驗給 10 分鐘
};
$('#btnPrev').onclick = ()=>{
  if(STATE.idx>0){ STATE.idx--; renderQuiz(); }
};
$('#btnNext').onclick = ()=>{
  if(STATE.idx<STATE.total-1){ STATE.idx++; renderQuiz(); }
};
$('#btnSubmit').onclick = ()=>submit();

/* ====== 初始化 ====== */
(async function init(){
  await loadQuestions();
})();
</script>
</body>
</html>
