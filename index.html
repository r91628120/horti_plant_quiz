<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>園藝丙級術科識別線上模擬測驗</title>
  <meta name="description" content="園藝丙級術科識別線上模擬測驗：100 題、40 分鐘，圖片單選題。題庫來源 Cloudinary，依 8 類比例抽題。" />
  <style>
    :root{
      --p:#2563eb; --bg:#f6f7fb; --card:#fff; --muted:#64748b; --ok:#16a34a; --warn:#eab308;
    }
    html,body{margin:0;font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#111}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.08);padding:22px}
    h1{font-size:30px;margin:0 0 10px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
    input[type=text]{padding:12px 14px;border:2px solid #e5e7eb;border-radius:10px;min-width:260px;font-size:16px}
    select{padding:12px;border-radius:10px;border:2px solid #e5e7eb}
    .btn{background:var(--p);color:#fff;border:0;border-radius:12px;padding:12px 18px;font-size:16px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:#e5e7eb;color:#111}
    .pill{display:inline-block;background:#eef2ff;color:#3730a3;border-radius:999px;padding:6px 10px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .qimg{width:100%;aspect-ratio:16/10;background:#e5e7eb;border-radius:12px;object-fit:contain}
    .opt{border:2px solid #e5e7eb;border-radius:12px;padding:10px 12px;display:flex;gap:10px;align-items:center;cursor:pointer}
    .opt input{transform:scale(1.1)}
    .opt.correct{border-color:var(--ok)}
    .opt.wrong{border-color:#ef4444}
    .toolbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:10px}
    .timer{font-weight:700}
    .footer{margin-top:30px;color:var(--muted);font-size:14px}
    .progress{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .progress>span{display:block;height:100%;background:var(--p);width:0%}
  </style>
</head>
<body>
<div class="wrap">
  <!-- 首頁 A -->
  <section id="home" class="card">
    <h1>園藝丙級術科識別線上模擬測驗</h1>
    <p class="muted">資料來源：勞動部勞動力發展署技能檢定中心。本網站圖片僅供教育與非營利用途，著作權歸原權利人所有，嚴禁未經授權之商業使用。</p>
    <p class="muted">測驗說明：本試題共測試 <b>100 題</b>，每題 1 分，總分 100 分，考試時間 <b>40 分鐘</b>。題型為單選題，需依試題圖片配合選項點選，正確點選者始給分；題目可前後閱視作答。</p>

    <div class="row" style="margin:12px 0 6px">
      <input id="nickname" type="text" placeholder="請輸入姓名或代號" />
      <select id="paperMode">
        <option value="all">全部題庫（依比例組卷）</option>
      </select>
    </div>

    <div class="row" style="margin-top:8px">
      <span class="pill">ver <span id="ver"></span></span>
      <span class="pill">目前累計測驗人數：<span id="pv">0</span> 人（本機）</span>
      <span class="pill">題庫：<span id="poolStat">–</span></span>
    </div>

    <div class="row" style="margin-top:16px">
      <button id="startBtn" class="btn">開始測驗（100 題）</button>
      <button id="try10" class="btn ghost">快速體驗（10 題）</button>
    </div>
  </section>

  <!-- 作答頁 B -->
  <section id="exam" class="card" style="display:none">
    <div class="toolbar">
      <div class="row">
        <span class="pill">考生：<span id="who"></span></span>
        <span class="pill">題數：<span id="qIdx">1</span> / <span id="qTotal">0</span></span>
      </div>
      <div class="timer">⏱ <span id="left">40:00</span></div>
    </div>
    <div class="progress" style="margin:12px 0"><span id="bar"></span></div>

    <h2 id="qTitle" style="margin:12px 0 8px">第 1 / 0 題</h2>
    <img id="qImage" class="qimg" alt="題目圖片" />
    <div id="opts" class="grid-2" style="margin-top:10px"></div>

    <div class="toolbar" style="margin-top:14px">
      <div class="row">
        <button id="prev" class="btn ghost">← 上一題</button>
        <button id="next" class="btn ghost">下一題 →</button>
      </div>
      <button id="submit" class="btn">交卷</button>
    </div>
  </section>

  <!-- 結果頁 C -->
  <section id="result" class="card" style="display:none">
    <h2>測驗結果</h2>
    <p>姓名／代號：<b id="rWho"></b>　題數：<b id="rCount"></b>　得分：<b id="rScore"></b>　版本：<span id="rVer"></span></p>
    <div id="rTable"></div>
    <div class="row" style="margin-top:16px">
      <button id="goHome" class="btn ghost">回首頁</button>
      <button id="retry" class="btn">再測一次</button>
    </div>
  </section>

  <p class="footer">© 2025 Horti ID Quiz．僅供教學示範（支援 <code>questions.json</code> 類別題庫）</p>
</div>

<script>
const VERSION = new Date().toISOString().slice(0,16).replace('T','-').replace(':','-');
document.getElementById('ver').textContent = 'v' + VERSION;

// ===== 資料載入與正規化 =====
async function loadQuestions() {
  const res = await fetch('questions.json?_=' + Date.now());
  const data = await res.json();
  return normalize(data);
}

// 支援兩種格式：
// 1) [{ name, image }]
// 2) { categories: [{ key,name,items:[{ name, image|url|secure_url }] }] }
function normalize(data){
  const out = { categories: [] };

  if (Array.isArray(data)) {
    // 舊格式 → 全部歸在 misc
    const items = data.map(x => ({
      name: x.name,
      image: x.image || x.url || x.secure_url || ''
    })).filter(x=>x.name && x.image);
    out.categories.push({ key:'misc', name:'全部', items });
    return out;
  }

  if (data && Array.isArray(data.categories)) {
    for (const c of data.categories) {
      const items = (c.items||[]).map(x => ({
        name: x.name,
        image: x.image || x.url || x.secure_url || ''
      })).filter(x=>x.name && x.image);
      if (items.length) out.categories.push({ key:c.key||c.name, name:c.name||c.key, items });
    }
    return out;
  }

  // 萬一格式不符，回傳空
  return { categories: [] };
}

// ===== 依比例組卷 =====
const RATIO = {
  'fruit': 20,
  'vegetables': 20,
  'aquatic_plants': 4,
  'vine_plants': 6,
  'herbaceous_plants': 20,
  'shrub': 10,
  'trees': 10,
  'materials': 10
};
// 類別鍵的對照（容錯：若 key 用不同命名）
const KEY_ALIAS = {
  'fruit':'fruit',
  'fruits':'fruit',
  'vegetables':'vegetables',
  'vegs':'vegetables',
  'aquatic plants':'aquatic_plants',
  'aquatic_plants':'aquatic_plants',
  'vine plants':'vine_plants',
  'vine_plants':'vine_plants',
  'herbaceous plants':'herbaceous_plants',
  'herbaceous_plants':'herbaceous_plants',
  'shrub':'shrub',
  'shrubs':'shrub',
  'trees':'trees',
  'tree':'trees',
  'materials':'materials',
  'material':'materials'
};

function aliasKey(k){
  const key = (k||'').toLowerCase().trim();
  return KEY_ALIAS[key] || key;
}

function pickN(arr, n){
  const a = arr.slice();
  const out = [];
  while (a.length && out.length < n){
    const i = Math.floor(Math.random()*a.length);
    out.push(a.splice(i,1)[0]);
  }
  return out;
}

function buildExamPool(normData, total=100){
  // 先把類別依 alias 整理到 map
  const map = {};
  for(const c of normData.categories){
    const key = aliasKey(c.key);
    if(!map[key]) map[key]=[];
    map[key] = map[key].concat(c.items);
  }

  // 依比例抽題
  const paper = [];
  for(const k in RATIO){
    const need = RATIO[k];
    const bag = map[k] || [];
    if (!bag.length) continue;
    paper.push(...pickN(bag, Math.min(need, bag.length)));
  }

  // 若硬是湊不到 100（某些類別圖片不足），就從全部補滿
  if (paper.length < total){
    const all = Object.values(map).flat();
    // 避免重複（用 image 當 key）
    const used = new Set(paper.map(x=>x.image));
    const candidates = all.filter(x=>!used.has(x.image));
    paper.push(...pickN(candidates, Math.max(0, total - paper.length)));
  }

  // 最後再洗牌
  return pickN(paper, Math.min(total, paper.length));
}

function buildOptions(correct, bag){
  // 從不同名稱抽 3 個錯誤
  const pool = bag.filter(x=>x.name !== correct.name);
  const wrong3 = pickN(pool, 3);
  const options = [
    {label:'A', text:correct.name, correct:true},
    ...wrong3.map((w,i)=>({label:String.fromCharCode(66+i), text:w.name, correct:false}))
  ];
  // 打散選項
  return pickN(options, options.length);
}

// ====== 畫面控制 ======
const $ = sel => document.querySelector(sel);
const show = id => {
  $('#home').style.display='none';
  $('#exam').style.display='none';
  $('#result').style.display='none';
  $(id).style.display='';
};

// 狀態
let DATA = null;          // 正規化後的 {categories}
let EXAM = [];            // 100 題
let CHOICES = [];         // 每題選項（含 A-D 與正誤）
let ANSW = [];            // 使用者答案（label）
let IDX = 0;              // 目前題號
let TIMER = null;         // setInterval
let LEFT = 40*60;         // 秒
let NICK = '';

function renderHomeStat(){
  // 顯示題庫總數（全部）
  const total = (DATA?.categories||[]).reduce((s,c)=>s+(c.items?.length||0),0);
  $('#poolStat').textContent = total ? total+' 張圖' : '–';

  // 累計人數（本機）
  const pv = Number(localStorage.getItem('horti_pv')||'0');
  $('#pv').textContent = pv;
}

function startTimer(){
  clearInterval(TIMER);
  const tick = ()=>{
    LEFT--;
    if(LEFT<0){ submitPaper(); return; }
    const m = String(Math.floor(LEFT/60)).padStart(2,'0');
    const s = String(LEFT%60).padStart(2,'0');
    $('#left').textContent = `${m}:${s}`;
    $('#bar').style.width = (100 - LEFT/(40*60)*100) + '%';
  };
  tick();
  TIMER = setInterval(tick,1000);
}

function renderQuestion(i){
  IDX = i;
  $('#qIdx').textContent = (i+1);
  $('#qTotal').textContent = EXAM.length;
  $('#qTitle').textContent = `第 ${i+1} / ${EXAM.length} 題`;
  $('#qImage').src = EXAM[i].image;

  const opts = CHOICES[i];
  const box = $('#opts');
  box.innerHTML = '';
  opts.forEach(o=>{
    const id = `q${i}_${o.label}`;
    const div = document.createElement('label');
    div.className = 'opt';
    div.innerHTML = `<input type="radio" name="q${i}" id="${id}" value="${o.label}"><b>${o.label}</b>．${o.text}`;
    box.appendChild(div);
  });

  // 回填已作答
  if (ANSW[i]){
    const r = document.querySelector(`input[name="q${i}"][value="${ANSW[i]}"]`);
    if (r) r.checked = true;
  }

  // 監聽
  box.addEventListener('change', (e)=>{
    if (e.target && e.target.name === `q${i}`){
      ANSW[i] = e.target.value;
    }
  });
}

function submitPaper(){
  clearInterval(TIMER);
  // 算分：答對即 1 分
  let score = 0;
  const rows = [];
  for (let i=0;i<EXAM.length;i++){
    const opt = CHOICES[i];
    const correct = opt.find(o=>o.correct).label;
    const mine = ANSW[i] || '-';
    if (mine === correct) score++;
    rows.push({i:i+1, img:EXAM[i].image, my:mine, ok:correct});
  }

  // 顯示結果
  $('#rWho').textContent = NICK;
  $('#rCount').textContent = EXAM.length;
  $('#rScore').textContent = score;
  $('#rVer').textContent = 'v'+VERSION;

  const tbl = ['<table border="0" cellspacing="0" cellpadding="8" style="width:100%;border-collapse:collapse">',
               '<tr style="background:#f8fafc"><th>#</th><th>題圖</th><th>你的答案</th><th>正確答案</th></tr>'];
  rows.forEach(r=>{
    tbl.push(`<tr>
      <td>${r.i}</td>
      <td><img src="${r.img}" style="width:160px;height:100px;object-fit:cover;border:1px solid #e5e7eb;border-radius:8px"/></td>
      <td>${r.my}</td>
      <td>${r.ok}</td>
    </tr>`);
  });
  tbl.push('</table>');
  $('#rTable').innerHTML = tbl.join('');

  // PV +1（本機）
  const pv = Number(localStorage.getItem('horti_pv')||'0') + 1;
  localStorage.setItem('horti_pv', String(pv));

  show('#result');
}

function startExam(total=100){
  if (!DATA || !DATA.categories?.length){
    alert('題庫載入失敗，請稍後再試。');
    return;
  }
  // 依比例抽題
  EXAM = buildExamPool(DATA, total);
  if (!EXAM.length){
    alert('題庫為空，請確認 questions.json。');
    return;
  }
  // 為每題建選項
  const all = DATA.categories.flatMap(c=>c.items);
  CHOICES = EXAM.map(q => buildOptions(q, all));
  ANSW = new Array(EXAM.length).fill(null);
  LEFT = 40*60;

  $('#who').textContent = NICK;
  $('#qTotal').textContent = EXAM.length;

  show('#exam');
  renderQuestion(0);
  startTimer();
}

// ===== 事件 =====
document.getElementById('startBtn').addEventListener('click', ()=>{
  NICK = $('#nickname').value.trim() || '匿名';
  startExam(100);
});
document.getElementById('try10').addEventListener('click', ()=>{
  NICK = $('#nickname').value.trim() || '匿名';
  startExam(10);
});
document.getElementById('prev').addEventListener('click', ()=>{ if (IDX>0) renderQuestion(IDX-1); });
document.getElementById('next').addEventListener('click', ()=>{ if (IDX<EXAM.length-1) renderQuestion(IDX+1); });
document.getElementById('submit').addEventListener('click', submitPaper);
document.getElementById('goHome').addEventListener('click', ()=>show('#home'));
document.getElementById('retry').addEventListener('click', ()=>{
  show('#home');
});

// ===== 啟動：載入題庫並顯示首頁 =====
(async ()=>{
  try{
    DATA = await loadQuestions();
  }catch(e){
    console.error(e);
    alert('載入題庫失敗：' + e.message);
  }
  renderHomeStat();
})();
</script>
</body>
</html>
